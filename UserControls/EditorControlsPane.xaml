<UserControl x:Class="MURDOC_2024.UserControls.EditorControlsPane"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:MURDOC_2024.UserControls"
             xmlns:converters="clr-namespace:MURDOC_2024.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="775" d:DesignWidth="380">

    <UserControl.Resources>
        <!-- Add the converter here -->
        <converters:BoolToVisibilityConverter x:Key="BoolToVisConverter"/>
    </UserControl.Resources>
    
    <Border BorderBrush="#CCCCCC" 
            BorderThickness="1" 
            Background="White"
            CornerRadius="4">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="12">

                <!-- ROI Drawing Tools Section -->
                <Label Content="Region of Interest (ROI)" FontWeight="Bold" FontSize="13"/>

                <TextBlock Text="Draw mode:" 
                           FontSize="12" 
                           Foreground="#666666" 
                           Margin="0,0,0,5"/>

                <Grid Margin="0,0,0,5">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Button Grid.Column="0" 
                            Content="🖊️ Polygon" 
                            Command="{Binding SetPolygonModeCommand}"
                            Margin="0,0,3,5"
                            ToolTip="Click points to create ROI polygon&#x0a;Right-click or Enter to finish"/>

                    <Button Grid.Column="1" 
                            Content="✏️ Freehand" 
                            Command="{Binding SetFreehandModeCommand}"
                            Margin="3,0,0,5"
                            ToolTip="Draw ROI freely with mouse"/>
                </Grid>

                <Grid Margin="0,0,0,5">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Button Grid.Column="0" 
                            Content="🗑️ Clear" 
                            Command="{Binding ClearROIsCommand}"
                            Margin="0,0,3,5"/>

                    <Button Grid.Column="1" 
                            Content="💾 Export" 
                            Command="{Binding ExportROIMasksCommand}"
                            Margin="3,0,0,5"
                            ToolTip="Save ROI masks as PNG files"/>
                </Grid>

                <!-- ROI Status Display -->
                <Border Background="#F0F0F0" 
                        Padding="8,5" 
                        CornerRadius="3"
                        Margin="0,0,0,10">
                    <StackPanel>
                        <TextBlock>
                            <Run Text="Active ROIs: " FontSize="11"/>
                            <Run Text="{Binding ROICount, Mode=OneWay}" 
                                 FontWeight="Bold" 
                                 FontSize="11"
                                 Foreground="#2196F3"/>
                        </TextBlock>
                        <TextBlock FontSize="10" 
                                   Foreground="#666666"
                                   Visibility="{Binding IsDrawingROI, Converter={StaticResource BoolToVisConverter}}">
                            <Run Text="⚠️ Drawing in progress..."/>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <Separator Margin="0,10,0,10" Background="#E0E0E0"/>

                <!-- Detection Feedback Section -->
                <Label Content="Detection Feedback" FontWeight="Bold" FontSize="13"/>

                <TextBlock Text="Select a detection to provide feedback"
                    FontSize="12"
                    Foreground="#666666"
                    TextWrapping="Wrap"
                    Margin="0,0,0,8"/>

                <!-- Current Selection Display -->
                <Border Background="#E3F2FD" 
                    Padding="8,5" 
                    CornerRadius="3"
                    Margin="0,0,0,8"
                    Visibility="{Binding HasSelectedDetection, Converter={StaticResource BoolToVisConverter}}">
                    <TextBlock FontSize="11" TextWrapping="Wrap">
                        <Run Text="Selected: " FontWeight="Bold"/>
                        <Run Text="{Binding SelectedDetectionLabel, Mode=OneWay}"/>
                        <LineBreak/>
                        <Run Text="Confidence: " FontWeight="Bold"/>
                        <Run Text="{Binding SelectedDetectionConfidence, StringFormat='{}{0:P2}', Mode=OneWay}"/>
                    </TextBlock>
                </Border>

                <!-- Feedback Action Buttons -->
                <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Button Grid.Column="0" 
                        Command="{Binding ConfirmDetectionCommand}"
                        Margin="0,0,3,0"
                        Padding="8,10"
                        Background="#E8F5E9"
                        BorderBrush="#4CAF50"
                        BorderThickness="2"
                        ToolTip="Confirm this detection is correct">
                        <StackPanel>
                            <TextBlock Text="✓ Confirm" 
                      FontWeight="Bold" 
                      Foreground="#4CAF50"
                      HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <Button Grid.Column="1" 
                        Command="{Binding RejectDetectionCommand}"
                        Margin="3,0,0,0"
                        Padding="8,10"
                        Background="#FFEBEE"
                        BorderBrush="#F44336"
                        BorderThickness="2"
                        ToolTip="Reject this detection as incorrect">
                        <StackPanel>
                            <TextBlock Text="✗ Reject" 
                      FontWeight="Bold" 
                      Foreground="#F44336"
                      HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </Grid>

                <!-- Add Correction Button -->
                <Button Command="{Binding EnableCorrectionModeCommand}"
                    Padding="8,10"
                    Margin="0,0,0,8"
                    Background="#FFF3E0"
                    BorderBrush="#FFB74D"
                    BorderThickness="2"
                    ToolTip="Draw polygon around object the system missed">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="➕ " 
                  FontWeight="Bold" 
                  Foreground="#FF9800"
                  FontSize="14"
                  VerticalAlignment="Center"/>
                        <TextBlock Text="Add Missed Object" 
                  FontWeight="Bold" 
                  Foreground="#FF9800"
                  VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <!-- Feedback Stats (Read-only summary) -->
                <Border Background="#F0F0F0" 
                    Padding="8" 
                    CornerRadius="3"
                    Margin="0,0,0,8">       
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="✓" 
                      Foreground="#4CAF50" 
                      FontWeight="Bold"
                      FontSize="14"
                      HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding ConfirmedCount, Mode=OneWay}" 
                      FontWeight="Bold"
                      FontSize="12"
                      HorizontalAlignment="Center"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1">
                            <TextBlock Text="✗" 
                      Foreground="#F44336" 
                      FontWeight="Bold"
                      FontSize="14"
                      HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding RejectedCount, Mode=OneWay}" 
                      FontWeight="Bold"
                      FontSize="12"
                      HorizontalAlignment="Center"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock Text="➕" 
                      Foreground="#FF9800" 
                      FontWeight="Bold"
                      FontSize="14"
                      HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding CorrectionCount, Mode=OneWay}" 
                      FontWeight="Bold"
                      FontSize="12"
                      HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <Button Content="📊 View Feedback History" 
                    Command="{Binding ViewFeedbackHistoryCommand}"
                    Margin="0,0,0,5"/>

                <Button Content="💾 Export Feedback Data" 
                    Command="{Binding ExportFeedbackCommand}"
                    Margin="0,0,0,5"
                    ToolTip="Save feedback history as JSON"/>

                <Separator Margin="0,10,0,10" Background="#E0E0E0"/>

                <!-- Add this in EditorControlsPane before Detection Feedback section -->
                <Label Content="Current Detections" FontWeight="Bold" FontSize="13"/>

                <ListBox ItemsSource="{Binding CurrentDetections}"
                     SelectedItem="{Binding SelectedDetection}"
                     Height="100"
                     Margin="0,0,0,10">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Label}" FontWeight="Bold" Margin="0,0,5,0"/>
                                <TextBlock Text="{Binding Confidence, StringFormat='({0:P0})'}" Foreground="#666"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <Separator Margin="0,10,0,10" Background="#E0E0E0"/> 

                <!-- Session Info -->
                <Label Content="Session Information" FontWeight="Bold" FontSize="13"/>

                <Border Background="#F5F5F5" 
                        Padding="8" 
                        CornerRadius="3">
                    <StackPanel>
                        <TextBlock FontSize="11">
                            <Run Text="Total Interactions: "/>
                            <Run Text="{Binding TotalInteractions, Mode=OneWay}" 
                                 FontWeight="Bold"/>
                        </TextBlock>
                        <TextBlock FontSize="11" Margin="0,3,0,0">
                            <Run Text="Session Start: "/>
                            <Run Text="{Binding SessionStartTime, StringFormat='HH:mm:ss'}" 
                                 FontWeight="Bold"/>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <Button Content="🔄 Reset Session" 
                        Command="{Binding ResetSessionCommand}"
                        Margin="0,8,0,0"
                        ToolTip="Clear all ROIs and feedback"/>

            </StackPanel>
        </ScrollViewer>
    </Border>
</UserControl>